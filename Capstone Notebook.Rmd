---
title: "Capstone R Notebook"
output: html_notebook
---



```{r}
library(Synth)
library(LowRankQP)
library(conflicted)
library(dplyr)
library(rvest)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(viridis)
library(hrbrthemes)
library(googlesheets4)
library(skimr)
library(kableExtra)
library(ggthemes)
library(stargazer)
library(kableExtra)
```

```{r echo=TRUE}
link <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ-8yfjgb7JFa_q4MvpU0vqtE6dnLR2veB8B-XZq-SzVUQKft1Wu05uCMalln9eCjD6Jc4IrRyZPqtn/pub?output=csv"
data <- read.csv(link, header=TRUE)
data
```

```{r echo=TRUE}
# Load required libraries
library(Synth)

# Define the treated unit, donor pool, and treated year
treated_unit <- 7  # Replace with the name/code of Poland in your dataset
# Review and adjust any country_removed variables if necessary

# Create the donor pool while excluding the country to be removed
donor_pool <- unique(data$country[data$region != treated_unit])

# Pretend the intervention happened in 2014 (placebo test)
pretend_treated_year <- 2014

# Review and adjust the selection of covariate variables
covariate_matrix <- data[data$year < pretend_treated_year, c("gdp", "inf", "pop", "unemp")]
column_datatype <- class(data$region)

dataprep_out <- dataprep(
  foo = data,
  predictors = c("migration", "gdp", "inf", "pop", "unemp"),  # Review and adjust the predictors
  dependent = "migration",  # Verify that the outcome variable is correctly specified
  unit.variable = "region",  # Verify the variable representing countries/regions
  time.variable = "year",
  treatment.identifier = treated_unit,
  controls.identifier = donor_pool,
  time.predictors.prior = 2000:2014,  # Adjust the time range for the placebo test
  time.optimize.ssr = 2000:2014,  # Adjust the time range for the placebo test
  unit.names.variable = "country",
  time.plot = 2000:2020,  # Adjust the time range for the placebo test
)

synth_out <- synth(dataprep_out)
print(synth_out)
```
```{r echo=TRUE}
path.plot(synth.res = synth_out,
          dataprep.res = dataprep_out,
          tr.intake = 2014,
          Ylab = "Migration",
          Xlab = "Year",
          Legend = c("Poland", "Synthetic Poland"),
          Main = "Poland vs Synthetic Poland" ,
          Ylim = c(0,500000)
          )
```

```{r echo=TRUE}
 gaps.plot(synth.res = synth_out,
          dataprep.res = dataprep_out,
          tr.intake = 2014,
          Ylab = "Effect",
          Xlab = "Year",
          Main = " Gap between migration flow in Poland and its synthetic version")
```

```{r}
mean(gaps[16:21])
```

```{r}
gaps <- dataprep_out$Y1plot - (dataprep_out$Y0plot %*% synth_out$solution.w)

donor_weights <- synth_out$solution.w
donor_names <- donor_pool

# Create a data frame with weights, names, and spacing
donor_data <- data.frame(Weights = donor_weights, Country = donor_names)

# Use stargazer to display the data frame
library(stargazer)
stargazer(donor_data, type = "text", summary = FALSE)
```


```{r echo=TRUE}
synth_tables <- synth.tab(dataprep.res = dataprep_out, synth.res = synth_out)

synth_tables[1:3]
# Names of the generated tables
#table_names <- names(synth_tables)
#synth.tables$tab.pred

```


## Placebo Test In Space

```{r}
if (!requireNamespace("remotes", quietly = TRUE)) {
  install.packages("remotes")
}

# Install SCtools package from GitHub
remotes::install_github("bcastanho/SCtools")

# Load SCtools package
```

```{r}
library(SCtools)
```

```{r}
placebo <- generate.placebos(dataprep_out, synth_out, Sigf.ipop = 2, strategy='multicore')
```

```{r}
p <- plot_placebos(placebo,discard.extreme=TRUE, mspe.limit=10, xlab='Year')
p
```

```{r}
mspe_plot(placebo)
```


```{r}
# Calculate the p-value
ratio <- mspe.test(placebo)
print(ratio$p.val)
print(ratio$test)
```


Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
